const express = require("express");
const fs = require("fs");
const app = express();
app.use(express.json());

const PORT = process.env.PORT || 3000;

// Função para ler histórico de cores
function readHistory() {
  try {
    const data = fs.readFileSync("history.json", "utf8");
    return JSON.parse(data);
  } catch (err) {
    return []; // Se não existir, retorna array vazio
  }
}

// Função para salvar nova cor no histórico
function saveHistory(color) {
  const history = readHistory();
  history.push(color);
  fs.writeFileSync("history.json", JSON.stringify(history, null, 2));
}

// Função de análise Abacus
function analyzeHistory(history) {
  if (!history.length) return { recommendation: "Sem dados ainda", stats: {} };

  const total = history.length;
  const counts = { Azul: 0, Vermelho: 0, Empate: 0 };

  history.forEach(c => {
    if (counts[c] !== undefined) counts[c]++;
  });

  // Tendência simples: comparação últimas 5 rodadas
  const last5 = history.slice(-5);
  const lastCounts = { Azul: 0, Vermelho: 0, Empate: 0 };
  last5.forEach(c => { if (lastCounts[c] !== undefined) lastCounts[c]++; });

  // Recomendação baseada na "tendência de correção"
  let recommendation = "Azul"; // default
  if (lastCounts.Azul > lastCounts.Vermelho && lastCounts.Azul > lastCounts.Empate) {
    recommendation = "Vermelho"; // correção esperada
  } else if (lastCounts.Vermelho > lastCounts.Azul && lastCounts.Vermelho > lastCounts.Empate) {
    recommendation = "Azul";
  } else {
    recommendation = "Empate";
  }

  return {
    recommendation,
    stats: {
      totalRounds: total,
      counts,
      last5
    }
  };
}

// Endpoint para adicionar nova cor
app.post("/add", (req, res) => {
  const { color } = req.body;
  if (!["Azul", "Vermelho", "Empate"].includes(color)) {
    return res.status(400).json({ error: "Cor inválida" });
  }
  saveHistory(color);
  res.json({ message: "Cor adicionada com sucesso!" });
});

// Endpoint para análise
app.get("/analyze", (req, res) => {
  const history = readHistory();
  const analysis = analyzeHistory(history);
  res.json(analysis);
});

app.listen(PORT, () => {
  console.log(`Servidor rodando em http://localhost:${PORT}`);
});
